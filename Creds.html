<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

    <script>
      let key = "";
      let action = "";
  
      const flowURL = "https://prod-56.westus.logic.azure.com:443/workflows/8dc98b9dd2b14d27a2da31292037d867/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=W4tx7krZ4eNbDAlobQ6AxIONancrwyvHu2PlnnrS6wQ";
      let custID = "";
      let custName = "";
      let mfrID = "";
      let mfrName = "";
      let status = "";
      let errorMessage = "";

      let setCredsFlowURL =
          "https://prod-187.westus.logic.azure.com:443/workflows/11ebd5c8637d43778720bf93d5ed80e3/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9CXGsZfzlnfsa7IjZoTdZM286mIdeTMVZvA58bjHpQk";

        function send2Flow() {
          //build the flow input as a JS object
          $("#message-area").val("Working, please wait...");
          var un = $("#username-field").val();
          var pw = $("#password-field").val();
     
          var flowInputJSON = {
            custID: parseInt(custID),
            mfrID: parseInt(mfrID),
            username: un,
            password: pw
          };

          var JSONStringified = JSON.stringify(flowInputJSON);
          console.log(JSONStringified);

          $.ajax({
            url: setCredsFlowURL,
            type: "post",
            dataType: "json",
            contentType: "application/json",
            success: function (data) {
           //  alert("got results from json")
           $("#message-area").val("");
             showfinal();

            }, //end of callback function
            error: function(e) {
              alert("got error calling flow");
              $("#submit-button").prop('disabled',false);
              $("#message-area").val("");
                      console.log(e);
            },
            data: JSONStringified
          });
        }


      function readParms()
      {
         const myURL = window.location.href;
         const urlPartsArray = myURL.split("?");
         if(urlPartsArray.length < 2)
         {
           return;
         }
         const queryString = urlPartsArray[1];
         const pairsArray = queryString.split("&");
         key = "";
         action = "";
         //loop thru each pair of attributes
         for(var i=0; i < pairsArray.length; i++)
         {
             var pairArray = pairsArray[i].split("=");
             var theKey = pairArray[0];
             var theVal = pairArray[1];
             
             if( theKey.toUpperCase() == "ACTION")
             {

               
                 action = theVal;
                 
             }

             if( theKey.toUpperCase() == "KEY")
             {
                 key = theVal;
                
             }
            

         }
           //alert("key is : " + key + " action is " + action);
         //remove
         //const urlParams = new  URLSearchParams(queryString);
        // key  = urlParams.get("key");
         //action = urlParams.get("action");

         
      }

      function readParms_old()
      {
         const myURL = window.location.href;
         const urlPartsArray = myURL.split("?");
         const queryString = urlPartsArray[1];
         alert(queryString);
         const urlParams = new  URLSearchParams(queryString);
         key  = urlParams.get("key");
         action = urlParams.get("action");
     
         
      }

      function handleJSONResults(data)
      {
          
          custID = data.custid;
          custName = data.customerName;
          mfrName = data.manufacturer;
          mfrID = data.mfrID;
          status = data.status;
          errorMessage = data.errorMessage;

          console.log("in handleJSONResults");
          console.log("customerID: " + custID);
          console.log("customerName: " +  custName);
          console.log("manufacturerName: " + mfrName);
          console.log("mfrID:" + mfrID);
          console.log("status : " + status);
          console.log("errorMessage: " + errorMessage);

          $("#creds-prompt").html("Please enter the credentials for the " + mfrName + " invoice site.");
          showMain()
      }

      function showMain()
      {
        $("#creds-init").hide();
        $("#creds-final").hide();
        $("#bad-link").hide();
        $("#main-div").show();

      }

      function showfinal()
      {
        $("#creds-init").hide();
        $("#main-div").hide();
        $("#bad-link").hide();
        $("#creds-final").show();
      }

      function showBadLink()
      {
        $("#creds-init").hide();
        $("#main-div").hide();
        $("#creds-final").hide();
        $("#bad-link").show();
      }

      
      function handleError(data)
      {
         
          showBadLink();
          $("#message-area").text = data.errorMessage;

      }
      function callVerifyFlow()
      {

         console.log("in callVerifyFlow");
         //build the input JSON
         let inputJSON = {
              "key"     : key
          }

          console.log("inputJSON");
         //**********************************
          // make the ajax call to the flow
          $.ajax({
            url: flowURL,
            type: "post",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify(inputJSON),
            success: function (data) {
                 //alert('got ajax result');
                 console.log("got ajax results");
                 if(data.status.toUpperCase() == "VALID")
                 {
                  handleJSONResults(data);
                
                 }
                 else
                 {
                    //alert("about to call handle error");
                    showBadLink();
                 }
                
                 console.log(data);
            }, //end of callback function
          }); // end of ajax call

      }  // end callVerifyFlow f(x)

      $(document).ready(function () {

        //create click listener for button
        $("#submit-button").click(function(){
         
          //disable the submit button while flow is running
          $(this).prop('disabled',true);

          $("#message-area").val("");
        
         // alert( $("username-field").val());
          if( $("#username-field").val() == "" || $("#password-field").val() == "" || $("#verify-field").val() == "")
          {
            
              $("#message-area").val("Username, Password and Verify Password fields are required");
              $(this).prop('disabled',false);
          }
          else
          {
               //call the flow
               if( $("#password-field").val() != $("#verify-field").val())
               {
                $("#message-area").val("The password and the verify password fields do not match");
                $(this).prop('disabled',false);

               }
               else
               {
                 // $("#message-area").val("Working, please wait...");
                  send2Flow();
                 // $("#message-area").val("");
                 
                 
               }
          }
          
        
        })


         //read the input parameters into key and action variables
        readParms();
       // alert("after readParms action is " + action + " key is : " + key);

        if( action.toUpperCase() != "CREDS" ||  !key )
        {
           //invalid URL show error div
           showBadLink();
        }
        else
        {
            
          //url looks good, so call flow to verify
            callVerifyFlow();
          
        } // end of if then else


      }); // end of document.ready f(x)
    </script>
  </head>

  <body>
    <div id="theContainer" class="containerDiv">
    <div id="main-div" class="contentDiv" >
      <center>
         <span id="creds-prompt" class="displayField" ></span>
         <br><br>
         <table id="spacing-table">
          <tr>
             <td><span class="fieldLabel"  >Username:</span></td>
             <td><input type="Text" id="username-field" class="displayField" ></text></td>
          </tr>
          <tr>
            <td><span class="fieldLabel"  >Password:</span></td>
            <td><input type="password" id="password-field" class="displayField" ></input></td>
          </tr>
          <tr>
            <td> <span class="fieldLabel" >Verify Password:</span></td>
            <td><input type="password" id="verify-field" class="displayField" ></input></td>
          </tr>
          
         </table>
         <br><br>
         <button id="submit-button" class="displayField" >Submit</button>
         <br><br>
         <textarea id="message-area" class="message-field" rows="3"  class="displayField" readonly></textarea>
        </center>
        </div>

        <div id="creds-init" class="contentDiv" >Loading, please wait...</div>
        <div id="creds-final" class="contentDiv" >Your credentials have been saved</div>
        <div id="bad-link" class="contentDiv" >This link is either invalid or expired.</div>

    </div>
  </body>
</html>
